<script>
/* global google, liff */
const state = {
  products: [],
  cart: new Map(),
  settings: {
    shop_lat: 0,
    shop_lng: 0,
    flat_rate: 0,
    distance_rate: 0
  },
  config: {
    liffId: '',
    googleMapsKey: '',
    env: 'dev'
  },
  auth: {
    idToken: '',
    userId: ''
  },
  adminPassword: '',
  selectedCoords: null,
  liffProfile: null
};

const elements = {
  loadingOverlay: document.getElementById('loading-overlay'),
  productGrid: document.getElementById('product-grid'),
  categoryFilter: document.getElementById('category-filter'),
  searchInput: document.getElementById('search-input'),
  cartBar: document.getElementById('cart-bar'),
  cartQty: document.querySelector('.cart-qty'),
  cartTotal: document.getElementById('cart-total'),
  cartModal: document.getElementById('cart-modal'),
  cartItems: document.getElementById('cart-items'),
  cartSubtotal: document.getElementById('cart-subtotal'),
  cartShipping: document.getElementById('cart-shipping'),
  cartGrand: document.getElementById('cart-grandtotal'),
  orderForm: document.getElementById('order-form'),
  orderName: document.getElementById('order-name'),
  orderPhone: document.getElementById('order-phone'),
  orderAddress: document.getElementById('order-address'),
  orderSlip: document.getElementById('order-slip'),
  distanceDisplay: document.getElementById('distance-display'),
  mapModal: document.getElementById('map-modal'),
  mapContainer: document.getElementById('map'),
  adminModal: document.getElementById('admin-modal'),
  adminLogin: document.getElementById('admin-login'),
  adminDashboard: document.getElementById('admin-dashboard'),
  adminPassword: document.getElementById('admin-password'),
  adminProductList: document.getElementById('admin-product-list'),
  adminOrderList: document.getElementById('admin-order-list'),
  settingLat: document.getElementById('setting-lat'),
  settingLng: document.getElementById('setting-lng'),
  settingFlat: document.getElementById('setting-flat'),
  settingDistance: document.getElementById('setting-distance'),
  settingPassword: document.getElementById('setting-password'),
  profileWrap: document.getElementById('liff-profile'),
  profileName: document.getElementById('profile-name'),
  profileId: document.getElementById('profile-id'),
  profileImage: document.getElementById('profile-image')
};

let map;
let marker;

const formatCurrency = (value) => `${Number(value || 0).toLocaleString('th-TH')} ฿`;

const showLoading = (message = 'กำลังโหลดข้อมูล...') => {
  elements.loadingOverlay.querySelector('p').textContent = message;
  elements.loadingOverlay.classList.remove('hidden');
};

const hideLoading = () => {
  elements.loadingOverlay.classList.add('hidden');
};

const showToast = (title, icon = 'success') => {
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon,
    title,
    showConfirmButton: false,
    timer: 3000
  });
};

const showAlert = (title, text, icon = 'info') => {
  Swal.fire({
    title,
    text,
    icon,
    confirmButtonText: 'ตกลง'
  });
};

const callServer = (method, payload = {}, options = {}) => new Promise((resolve, reject) => {
  const gasRunner = window.google && window.google.script && window.google.script.run;
  if (!gasRunner) {
    reject(new Error('ไม่สามารถเชื่อมต่อ Google Apps Script ได้ กรุณาเปิดผ่าน Web App หรือ LINE LIFF'));
    return;
  }
  const request = { ...payload };
  if (options.authRequired !== false) {
    if (!state.auth.idToken || !state.auth.userId) {
      reject(new Error('ยังไม่ได้ยืนยันตัวตน LINE LIFF'));
      return;
    }
    request.auth = { ...state.auth };
  }
  gasRunner.withSuccessHandler(resolve).withFailureHandler(reject)[method](request);
});

const initLiff = async () => {
  if (!state.config.liffId) {
    return;
  }
  try {
    await liff.init({ liffId: state.config.liffId });
    if (!liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    state.liffProfile = profile;
    state.auth = {
      idToken: liff.getIDToken(),
      userId: profile.userId
    };
    elements.profileName.textContent = profile.displayName;
    elements.profileId.textContent = `LINE ID: ${profile.userId}`;
    elements.profileImage.src = profile.pictureUrl;
    elements.profileWrap.classList.remove('hidden');
    elements.profileWrap.classList.add('flex');
  } catch (error) {
    console.error(error);
  }
};

const loadMapsScript = () => new Promise((resolve, reject) => {
  if (!state.config.googleMapsKey) {
    reject(new Error('ยังไม่ได้ตั้งค่า Google Maps Key'));
    return;
  }
  if (window.google && window.google.maps) {
    resolve();
    return;
  }
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=${state.config.googleMapsKey}&libraries=places`;
  script.async = true;
  script.onload = resolve;
  script.onerror = () => reject(new Error('โหลดแผนที่ไม่สำเร็จ'));
  document.head.appendChild(script);
});

const loadPublicConfig = async () => {
  const config = await callServer('getPublicConfig', {}, { authRequired: false });
  state.config = {
    liffId: config.liffId || '',
    googleMapsKey: config.googleMapsKey || '',
    env: config.env || 'dev'
  };
};

const renderProducts = (products) => {
  if (!products.length) {
    elements.productGrid.innerHTML = `
      <div class="col-span-full rounded-2xl border border-dashed border-slate-200 bg-white p-8 text-center text-slate-500">
        <i class="fa-solid fa-face-frown text-3xl text-slate-300"></i>
        <p class="mt-3">ไม่พบสินค้าในขณะนี้</p>
      </div>
    `;
    return;
  }

  elements.productGrid.innerHTML = products.map((product) => {
    const available = product.is_available === 'TRUE' || product.is_available === true || product.is_available === 'true';
    return `
      <div class="rounded-3xl border border-slate-100 bg-white p-4 shadow-sm transition hover:-translate-y-1 hover:shadow-lg">
        <div class="relative">
          <img src="${product.image}" alt="${product.name}" class="h-44 w-full rounded-2xl object-cover" />
          <span class="absolute right-3 top-3 rounded-full bg-white/90 px-3 py-1 text-xs font-semibold text-slate-700">${product.category}</span>
          ${!available ? '<span class="absolute inset-0 rounded-2xl bg-white/70 text-center text-sm font-semibold text-slate-500 flex items-center justify-center">สินค้าหมด</span>' : ''}
        </div>
        <div class="mt-4 flex flex-col gap-2">
          <h3 class="text-base font-semibold text-slate-800">${product.name}</h3>
          <p class="text-sm text-slate-500">คงเหลือ ${product.stock}</p>
          <div class="flex items-center justify-between">
            <span class="text-lg font-bold text-indigo-600">${formatCurrency(product.price)}</span>
            <button class="btn-primary" data-add="${product.id}" ${available ? '' : 'disabled'}>
              <i class="fa-solid fa-plus"></i>
              เพิ่ม
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
};

const refreshCart = () => {
  const items = Array.from(state.cart.values());
  const subtotal = items.reduce((sum, item) => sum + item.price * item.qty, 0);
  const shipping = calculateShipping();
  const grand = subtotal + shipping;

  elements.cartQty.textContent = items.reduce((sum, item) => sum + item.qty, 0);
  elements.cartTotal.textContent = formatCurrency(grand);

  elements.cartItems.innerHTML = items.length
    ? items.map((item) => `
      <div class="flex items-center justify-between rounded-2xl bg-slate-50 p-3">
        <div>
          <p class="text-sm font-semibold">${item.name}</p>
          <p class="text-xs text-slate-500">${formatCurrency(item.price)} x ${item.qty}</p>
        </div>
        <div class="flex items-center gap-2">
          <button class="rounded-full bg-white px-2 py-1 text-slate-600" data-decrease="${item.id}">-</button>
          <span class="text-sm font-semibold">${item.qty}</span>
          <button class="rounded-full bg-white px-2 py-1 text-slate-600" data-increase="${item.id}">+</button>
        </div>
      </div>
    `).join('')
    : '<p class="text-sm text-slate-400">ยังไม่มีสินค้าในตะกร้า</p>';

  elements.cartSubtotal.textContent = formatCurrency(subtotal);
  elements.cartShipping.textContent = formatCurrency(shipping);
  elements.cartGrand.textContent = formatCurrency(grand);
};

const calculateShipping = () => {
  const shippingType = document.querySelector('input[name="shippingType"]:checked').value;
  if (shippingType === 'manual') {
    return Number(state.settings.flat_rate || 0);
  }
  if (state.selectedCoords) {
    const distance = haversineDistance(
      state.settings.shop_lat,
      state.settings.shop_lng,
      state.selectedCoords.lat,
      state.selectedCoords.lng
    );
    return Math.ceil(distance * Number(state.settings.distance_rate || 0));
  }
  return Number(state.settings.flat_rate || 0);
};

const haversineDistance = (lat1, lng1, lat2, lng2) => {
  const toRad = (value) => (value * Math.PI) / 180;
  const radius = 6371;
  const dLat = toRad(lat2 - lat1);
  const dLng = toRad(lng2 - lng1);
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLng / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return radius * c;
};

const updateDistanceDisplay = () => {
  if (!state.selectedCoords) {
    elements.distanceDisplay.textContent = 'ระยะทางยังไม่ถูกคำนวณ';
    return;
  }
  const distance = haversineDistance(
    state.settings.shop_lat,
    state.settings.shop_lng,
    state.selectedCoords.lat,
    state.selectedCoords.lng
  );
  elements.distanceDisplay.textContent = `ระยะทางประมาณ ${distance.toFixed(2)} กม.`;
};

const openModal = (modal) => {
  modal.classList.remove('hidden');
};

const closeModal = (modal) => {
  modal.classList.add('hidden');
};

const handleAddToCart = (productId) => {
  const product = state.products.find((item) => item.id === productId);
  if (!product) return;
  if (state.cart.has(productId)) {
    const item = state.cart.get(productId);
    item.qty += 1;
    state.cart.set(productId, item);
  } else {
    state.cart.set(productId, { ...product, qty: 1 });
  }
  refreshCart();
  showToast('เพิ่มสินค้าในตะกร้าแล้ว');
};

const handleCartUpdate = (productId, delta) => {
  if (!state.cart.has(productId)) return;
  const item = state.cart.get(productId);
  item.qty += delta;
  if (item.qty <= 0) {
    state.cart.delete(productId);
  } else {
    state.cart.set(productId, item);
  }
  refreshCart();
};

const buildOrderPayload = async () => {
  const items = Array.from(state.cart.values());
  const total = items.reduce((sum, item) => sum + item.price * item.qty, 0);
  const shippingFee = calculateShipping();
  const slipFile = elements.orderSlip.files[0];
  const slipBase64 = await fileToBase64(slipFile);
  return {
    customer_name: elements.orderName.value.trim(),
    phone: elements.orderPhone.value.trim(),
    address: elements.orderAddress.value.trim(),
    items,
    total_price: total,
    shipping_fee: shippingFee,
    slip_base64: slipBase64.split(',')[1],
    slip_mime: slipFile.type,
    liff_profile: state.liffProfile
  };
};

const submitOrder = async (event) => {
  event.preventDefault();
  if (!state.cart.size) {
    showAlert('ตะกร้าว่าง', 'กรุณาเพิ่มสินค้าในตะกร้าก่อน', 'warning');
    return;
  }
  if (!elements.orderName.value.trim() || !elements.orderPhone.value.trim() || !elements.orderAddress.value.trim()) {
    showAlert('ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลให้ครบถ้วน', 'warning');
    return;
  }
  if (!elements.orderSlip.files.length) {
    showAlert('ยังไม่ได้แนบสลิป', 'กรุณาแนบหลักฐานการโอนเงิน', 'warning');
    return;
  }

  const confirm = await Swal.fire({
    title: 'ยืนยันการสั่งซื้อ',
    text: 'ตรวจสอบข้อมูลให้ครบก่อนยืนยัน',
    icon: 'question',
    showCancelButton: true,
    confirmButtonText: 'ยืนยัน',
    cancelButtonText: 'ยกเลิก'
  });

  if (!confirm.isConfirmed) return;

  try {
    showLoading('กำลังตรวจสอบสลิป...');
    const payload = await buildOrderPayload();
    const result = await callServer('submitOrder', payload);
    hideLoading();

    if (result.success) {
      state.cart.clear();
      refreshCart();
      elements.orderForm.reset();
      state.selectedCoords = null;
      updateDistanceDisplay();
      closeModal(elements.cartModal);
      showAlert('สั่งซื้อสำเร็จ', `เลขที่ออเดอร์: ${result.order_id}`, 'success');
    } else {
      showAlert('สั่งซื้อไม่สำเร็จ', result.message || 'กรุณาลองใหม่', 'error');
    }
  } catch (error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาด', error.message, 'error');
  }
};

const fileToBase64 = (file) => new Promise((resolve, reject) => {
  const reader = new FileReader();
  reader.onload = () => resolve(reader.result);
  reader.onerror = reject;
  reader.readAsDataURL(file);
});

const openMap = async () => {
  try {
    await loadMapsScript();
    openModal(elements.mapModal);
    setTimeout(() => {
      map = new google.maps.Map(elements.mapContainer, {
        center: { lat: Number(state.settings.shop_lat), lng: Number(state.settings.shop_lng) },
        zoom: 14
      });
      map.addListener('click', (event) => {
        const position = {
          lat: event.latLng.lat(),
          lng: event.latLng.lng()
        };
        if (marker) {
          marker.setMap(null);
        }
        marker = new google.maps.Marker({ position, map });
        state.selectedCoords = position;
      });
    }, 200);
  } catch (error) {
    showAlert('ไม่สามารถโหลดแผนที่', error.message, 'error');
  }
};

const useCurrentLocation = () => {
  if (!navigator.geolocation) {
    showAlert('ไม่รองรับ', 'เบราว์เซอร์ไม่รองรับการระบุตำแหน่ง', 'warning');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (position) => {
      state.selectedCoords = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      updateDistanceDisplay();
      refreshCart();
      showToast('บันทึกตำแหน่งเรียบร้อย');
    },
    () => {
      showAlert('ไม่สำเร็จ', 'ไม่สามารถดึงตำแหน่งได้', 'error');
    }
  );
};

const confirmLocation = () => {
  if (!state.selectedCoords) {
    showAlert('ยังไม่ได้เลือกตำแหน่ง', 'กรุณาคลิกบนแผนที่เพื่อเลือกตำแหน่ง', 'warning');
    return;
  }
  updateDistanceDisplay();
  refreshCart();
  closeModal(elements.mapModal);
  showToast('ยืนยันตำแหน่งเรียบร้อย');
};

const initAdminDashboard = () => {
  elements.settingLat.value = state.settings.shop_lat;
  elements.settingLng.value = state.settings.shop_lng;
  elements.settingFlat.value = state.settings.flat_rate;
  elements.settingDistance.value = state.settings.distance_rate;
  elements.settingPassword.value = '';

  elements.adminProductList.innerHTML = state.products.map((product) => {
    const checked = product.is_available === 'TRUE' || product.is_available === true || product.is_available === 'true';
    return `
      <div class="flex items-center justify-between rounded-xl bg-slate-50 p-3">
        <div>
          <p class="text-sm font-semibold">${product.name}</p>
          <p class="text-xs text-slate-500">${formatCurrency(product.price)}</p>
        </div>
        <label class="inline-flex cursor-pointer items-center gap-2 text-xs text-slate-600">
          <input type="checkbox" data-toggle="${product.id}" ${checked ? 'checked' : ''} />
          เปิดขาย
        </label>
      </div>
    `;
  }).join('');
};

const loadOrders = async () => {
  if (!state.adminPassword) {
    showAlert('สิทธิ์ไม่เพียงพอ', 'กรุณาเข้าสู่ระบบผู้ดูแลก่อน', 'warning');
    return;
  }
  const orders = await callServer('getOrders', { admin_password: state.adminPassword });
  elements.adminOrderList.innerHTML = orders.length
    ? orders.map((order) => `
      <div class="rounded-xl border border-slate-100 p-3">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-semibold">${order.customer_name}</p>
            <p class="text-xs text-slate-500">${order.order_id}</p>
          </div>
          <span class="text-xs font-semibold text-indigo-600">${formatCurrency(order.total_price)}</span>
        </div>
        <div class="mt-2 flex items-center justify-between text-xs">
          <span class="text-slate-500">สถานะ: ${order.status}</span>
          <button class="btn-outline" data-order="${order.order_id}">อัปเดตสถานะ</button>
        </div>
      </div>
    `).join('')
    : '<p class="text-sm text-slate-400">ไม่มีรายการออเดอร์</p>';
};

const handleAdminLogin = async () => {
  if (!elements.adminPassword.value.trim()) {
    showAlert('รหัสผ่านไม่ถูกต้อง', 'กรุณากรอกรหัสผ่าน', 'warning');
    return;
  }
  try {
    showLoading('กำลังตรวจสอบสิทธิ์...');
    const password = elements.adminPassword.value.trim();
    const result = await callServer('verifyAdminLogin', { password });
    hideLoading();
    if (!result.success) {
      showAlert('รหัสผ่านไม่ถูกต้อง', result.message || 'กรุณาลองใหม่อีกครั้ง', 'error');
      return;
    }
    state.adminPassword = password;
    elements.adminLogin.classList.add('hidden');
    elements.adminDashboard.classList.remove('hidden');
    initAdminDashboard();
    await loadOrders();
  } catch (error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาด', error.message, 'error');
  }
};

const saveSettings = async () => {
  try {
    showLoading('กำลังบันทึกการตั้งค่า...');
    const payload = {
      shop_lat: Number(elements.settingLat.value),
      shop_lng: Number(elements.settingLng.value),
      flat_rate: Number(elements.settingFlat.value),
      distance_rate: Number(elements.settingDistance.value),
      admin_password: state.adminPassword,
      new_admin_password: elements.settingPassword.value.trim() || ''
    };
    const result = await callServer('updateSettings', payload);
    hideLoading();
    if (result.success) {
      state.settings = {
        ...state.settings,
        shop_lat: payload.shop_lat,
        shop_lng: payload.shop_lng,
        flat_rate: payload.flat_rate,
        distance_rate: payload.distance_rate
      };
      showToast('บันทึกการตั้งค่าเรียบร้อย');
    } else {
      showAlert('บันทึกไม่สำเร็จ', result.message, 'error');
    }
  } catch (error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาด', error.message, 'error');
  }
};

const updateProductAvailability = async (productId, isAvailable) => {
  try {
    await callServer('updateProductAvailability', {
      id: productId,
      is_available: isAvailable,
      admin_password: state.adminPassword
    });
    showToast('อัปเดตสินค้าเรียบร้อย');
  } catch (error) {
    showAlert('เกิดข้อผิดพลาด', error.message, 'error');
  }
};

const updateOrderStatus = async (orderId) => {
  const { value } = await Swal.fire({
    title: 'อัปเดตสถานะออเดอร์',
    input: 'select',
    inputOptions: {
      Pending: 'Pending',
      Success: 'Success',
      Cancelled: 'Cancelled'
    },
    inputPlaceholder: 'เลือกสถานะ',
    showCancelButton: true,
    confirmButtonText: 'บันทึก',
    cancelButtonText: 'ยกเลิก'
  });
  if (!value) return;
  try {
    showLoading('กำลังอัปเดตสถานะ...');
    const result = await callServer('updateOrderStatus', {
      order_id: orderId,
      status: value,
      admin_password: state.adminPassword
    });
    hideLoading();
    if (result.success) {
      showToast('อัปเดตสถานะเรียบร้อย');
      await loadOrders();
    } else {
      showAlert('ไม่สำเร็จ', result.message, 'error');
    }
  } catch (error) {
    hideLoading();
    showAlert('เกิดข้อผิดพลาด', error.message, 'error');
  }
};

const filterProducts = () => {
  const keyword = elements.searchInput.value.toLowerCase();
  const category = elements.categoryFilter.value;
  const filtered = state.products.filter((product) => {
    const matchesKeyword = product.name.toLowerCase().includes(keyword);
    const matchesCategory = category === 'all' || product.category === category;
    return matchesKeyword && matchesCategory;
  });
  renderProducts(filtered);
};

const initData = async () => {
  try {
    showLoading('กำลังโหลดข้อมูลร้านค้า...');
    const [products, settings] = await Promise.all([
      callServer('getProducts'),
      callServer('getSettings')
    ]);
    state.products = products;
    state.settings = settings;

    const categories = Array.from(new Set(products.map((product) => product.category))).filter(Boolean);
    elements.categoryFilter.innerHTML = '<option value="all">ทุกหมวดหมู่</option>' + categories.map((category) => `
      <option value="${category}">${category}</option>
    `).join('');

    renderProducts(products);
    refreshCart();
    hideLoading();
  } catch (error) {
    hideLoading();
    showAlert('โหลดข้อมูลไม่สำเร็จ', error.message, 'error');
  }
};

const attachEvents = () => {
  elements.productGrid.addEventListener('click', (event) => {
    const target = event.target.closest('[data-add]');
    if (target) {
      handleAddToCart(target.dataset.add);
    }
  });

  elements.cartBar.addEventListener('click', () => openModal(elements.cartModal));

  document.querySelectorAll('[data-close]').forEach((button) => {
    button.addEventListener('click', () => closeModal(document.getElementById(button.dataset.close)));
  });

  elements.cartItems.addEventListener('click', (event) => {
    const increase = event.target.closest('[data-increase]');
    const decrease = event.target.closest('[data-decrease]');
    if (increase) {
      handleCartUpdate(increase.dataset.increase, 1);
    }
    if (decrease) {
      handleCartUpdate(decrease.dataset.decrease, -1);
    }
  });

  elements.orderForm.addEventListener('submit', submitOrder);

  elements.searchInput.addEventListener('input', filterProducts);
  elements.categoryFilter.addEventListener('change', filterProducts);

  document.getElementById('btn-open-map').addEventListener('click', openMap);
  document.getElementById('btn-current-location').addEventListener('click', useCurrentLocation);
  document.getElementById('btn-confirm-location').addEventListener('click', confirmLocation);

  document.getElementById('btn-admin').addEventListener('click', () => openModal(elements.adminModal));
  document.getElementById('btn-admin-login').addEventListener('click', handleAdminLogin);
  document.getElementById('btn-save-settings').addEventListener('click', saveSettings);

  elements.adminProductList.addEventListener('change', (event) => {
    const toggle = event.target.closest('[data-toggle]');
    if (toggle) {
      updateProductAvailability(toggle.dataset.toggle, toggle.checked);
    }
  });

  elements.adminOrderList.addEventListener('click', (event) => {
    const button = event.target.closest('[data-order]');
    if (button) {
      updateOrderStatus(button.dataset.order);
    }
  });

  document.querySelectorAll('input[name="shippingType"]').forEach((radio) => {
    radio.addEventListener('change', () => {
      updateDistanceDisplay();
      refreshCart();
    });
  });

  document.getElementById('btn-track-order').addEventListener('click', () => {
    showAlert('ติดตามออเดอร์', 'โปรดติดต่อร้านค้าหรือเช็คสถานะในแดชบอร์ด', 'info');
  });
};

const init = async () => {
  attachEvents();
  try {
    await loadPublicConfig();
  } catch (error) {
    showAlert('ตั้งค่าไม่ครบ', error.message, 'error');
    return;
  }
  await initLiff();
  if (!state.auth.idToken || !state.auth.userId) {
    showAlert('ยังไม่ได้ยืนยันตัวตน', 'กรุณาเปิดผ่าน LINE LIFF', 'warning');
    return;
  }
  await initData();
};

init();
</script>
