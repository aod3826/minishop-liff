<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Shop - ‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-color: #f8f9fa;
            --text-color: #333333;
            --light-gray: #f1f5f9;
            --card-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            --header-shadow: 0 10px 30px rgba(118, 75, 162, 0.2);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Prompt', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 120px;
            line-height: 1.6;
        }

        /* Header Section */
        .header-cover {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            padding: 40px 20px 30px;
            border-radius: 0 0 35px 35px;
            color: white;
            box-shadow: var(--header-shadow);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .header-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" preserveAspectRatio="none"><path d="M0,0 L1000,0 L1000,100 L0,100 Z" fill="rgba(255,255,255,0.05)"/></svg>');
            background-size: cover;
        }

        .shop-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .shop-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }

        /* Member Badge */
        .member-badge {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px 15px;
            display: inline-flex;
            align-items: center;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 300px;
            width: 100%;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .user-info {
            flex-grow: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-points {
            font-size: 0.85rem;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .points-icon {
            margin-right: 4px;
        }

        /* Category Scroll */
        .category-scroll {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 15px 20px;
            margin: 0 -20px 20px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .category-scroll::-webkit-scrollbar {
            display: none;
        }

        .category-pill {
            cursor: pointer;
            border-radius: 50px;
            padding: 8px 22px;
            background: white;
            border: 1px solid #e2e8f0;
            margin-right: 10px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
            flex-shrink: 0;
        }

        .category-pill:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .category-pill.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Product Cards */
        .product-card {
            border: none;
            border-radius: 18px;
            overflow: hidden;
            background: white;
            box-shadow: var(--card-shadow);
            transition: all 0.3s;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .product-img-container {
            position: relative;
            overflow: hidden;
            height: 160px;
        }

        .product-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .product-card:hover .product-img {
            transform: scale(1.05);
        }

        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 10;
        }

        .out-of-stock-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .product-card.out-of-stock {
            filter: grayscale(0.8);
            opacity: 0.7;
        }

        .product-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .product-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .product-price {
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }

        .product-category {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #f1f5f9;
        }

        /* Cart Bar */
        .cart-bar {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            background: linear-gradient(135deg, #2d3436, #1a1e21);
            color: white;
            border-radius: 16px;
            padding: 16px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }

        .cart-bar:hover {
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .cart-items-count {
            background: white;
            color: #2d3436;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .cart-text {
            font-weight: 600;
            font-size: 1rem;
        }

        .cart-total {
            font-weight: 700;
            font-size: 1.3rem;
        }

        /* Staff Dashboard */
        .staff-btn-container {
            position: fixed;
            bottom: 110px;
            right: 20px;
            z-index: 999;
        }

        .staff-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d3436, #1a1e21);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            cursor: pointer;
        }

        .staff-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4);
        }

        .staff-dashboard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 2000;
            overflow-y: auto;
            display: none;
        }

        .dashboard-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .stat-card {
            background: linear-gradient(135deg, #00b09b, #96c93d);
            color: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 20px rgba(0, 176, 155, 0.2);
        }

        /* Map Styles */
        #map {
            height: 350px;
            width: 100%;
            border-radius: 12px;
            margin-top: 10px;
            border: 1px solid #e2e8f0;
        }

        .pac-container {
            z-index: 1051 !important;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            font-family: 'Prompt', sans-serif;
        }

        /* Modal Styles */
        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            border-bottom: 1px solid #f1f5f9;
            padding: 20px 25px;
        }

        .modal-title {
            font-weight: 700;
            color: #2d3436;
        }

        .modal-body {
            padding: 25px;
        }

        /* Form Styles */
        .form-label {
            font-weight: 500;
            color: #475569;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .form-control, .form-select {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 10px 15px;
            font-size: 0.95rem;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            border-radius: 10px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.3s;
            border: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .shop-title {
                font-size: 1.5rem;
            }
            
            .product-img-container {
                height: 140px;
            }
            
            .cart-bar {
                bottom: 20px;
                padding: 14px 20px;
            }
            
            .staff-btn-container {
                bottom: 90px;
                right: 15px;
            }
            
            .staff-btn {
                width: 55px;
                height: 55px;
            }
        }

        @media (max-width: 576px) {
            .header-cover {
                padding: 30px 15px 25px;
                border-radius: 0 0 25px 25px;
            }
            
            .category-scroll {
                padding: 12px 15px;
                margin: 0 -15px 15px;
            }
            
            .product-name {
                font-size: 0.9rem;
            }
            
            .product-price {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="header-cover text-center animate__animated animate__fadeIn">
        <h1 class="shop-title mb-2">
            <i class="fas fa-store me-2"></i>Mini Shop
        </h1>
        <p class="shop-subtitle">‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏£‡πà‡∏≠‡∏¢ ‡∏™‡∏î‡πÉ‡∏´‡∏°‡πà ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏ï‡∏•‡∏≠‡∏î 24 ‡∏ä‡∏°.</p>
        
        <!-- User Profile -->
        <div id="profile-info" class="d-none animate__animated animate__fadeInUp">
            <div class="member-badge">
                <img id="user-img" src="" class="user-avatar" alt="Profile Picture">
                <div class="user-info">
                    <div id="user-name" class="user-name">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
                    <div id="user-points-display" class="user-points text-warning">
                        <span class="points-icon">
                            <i class="fas fa-coins"></i>
                        </span>
                        <span id="points-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Categories -->
        <div class="category-scroll" id="category-container">
            <span class="category-pill active" onclick="filterProduct('all', event)">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
        </div>

        <!-- Products Grid -->
        <div id="product-list">
            <div class="row g-3">
                <div class="col-12">
                    <div class="text-center py-5">
                        <div class="loading-spinner" style="border-top-color: var(--primary-color);"></div>
                        <p class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Staff Dashboard Button -->
    <div id="staff-entry" class="staff-btn-container d-none animate__animated animate__zoomIn">
        <button class="staff-btn" onclick="showStaffDashboard()">
            <i class="fas fa-chart-pie fa-lg"></i>
        </button>
    </div>

    <!-- Cart Bar -->
    <div class="cart-bar animate__animated animate__fadeInUp" id="cart-bar" onclick="openCartModal()">
        <div class="d-flex align-items-center">
            <div class="cart-items-count" id="total-qty">0</div>
            <span class="cart-text">‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
        </div>
        <div class="cart-total">
            <span id="total-price">0</span> <small>‡∏ø</small>
            <i class="fas fa-chevron-right ms-2 opacity-75"></i>
        </div>
    </div>

    <!-- Staff Dashboard -->
    <div id="staff-dashboard" class="staff-dashboard-overlay">
        <div class="dashboard-header">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold">
                        <i class="fas fa-chart-line me-2 text-primary"></i>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                    </h5>
                    <button class="btn btn-sm btn-light rounded-pill px-3" onclick="hideStaffDashboard()">
                        <i class="fas fa-times me-1"></i> ‡∏õ‡∏¥‡∏î
                    </button>
                </div>
            </div>
        </div>
        
        <div class="container mt-4 pb-5">
            <!-- Sales Stats -->
            <div class="stat-card">
                <h6 class="fw-bold mb-4 opacity-90">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h6>
                <div class="row text-center">
                    <div class="col-6 border-end border-white border-opacity-25">
                        <small class="d-block opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</small>
                        <span class="fw-bold fs-3" id="stat-today">0</span> ‡∏ø
                    </div>
                    <div class="col-6">
                        <small class="d-block opacity-90 mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</small>
                        <span class="fw-bold fs-3" id="stat-orders">0</span>
                    </div>
                </div>
                <div class="row mt-4 text-center">
                    <div class="col-6 border-end border-white border-opacity-25">
                        <small class="d-block opacity-90 mb-1">‡∏¢‡∏≠‡∏î‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</small>
                        <span class="fw-bold fs-4" id="stat-realized">0</span> ‡∏ø
                    </div>
                    <div class="col-6">
                        <small class="d-block opacity-90 mb-1">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</small>
                        <span class="fw-bold fs-4" id="stat-pending">0</span> ‡∏ø
                    </div>
                </div>
            </div>

            <!-- Top Products -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <h6 class="fw-bold mb-3 text-muted">
                        <i class="fas fa-crown me-2 text-warning"></i>‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ Top 5
                    </h6>
                    <ul id="stat-top-menu" class="list-unstyled mb-0">
                        <li class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="fw-bold m-0 text-muted">
                    <i class="fas fa-clock-rotate-left me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
                </h6>
                <button class="btn btn-sm btn-outline-primary rounded-pill px-3" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt me-1"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>
            <div class="card border-0 shadow-sm">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                                <th>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏¢‡∏≠‡∏î</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="admin-orders-table">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ==========================================
         API CLIENT - JavaScript
         ========================================== -->
    <script>
        // ‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà YOUR_SCRIPT_ID ‡∏î‡πâ‡∏ß‡∏¢ Script ID ‡∏à‡∏£‡∏¥‡∏á
        const API_URL = "https://script.google.com/macros/d/YOUR_SCRIPT_ID/usercallable";

        // ============ CONFIG ============
        const API_CONFIG = {
            timeout: 15000, // 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
            retryCount: 3
        };

        // ============ UTILITY FUNCTIONS ============

        /**
         * ‡∏™‡πà‡∏á GET request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á API
         */
        async function apiGet(action, params = {}) {
            try {
                const queryString = new URLSearchParams({
                    action,
                    ...params
                }).toString();
                
                const url = `${API_URL}?${queryString}`;
                
                console.log('üì§ GET:', url);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
                
                const response = await fetch(url, {
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('üì• Response:', data);
                
                return data;
            } catch (error) {
                console.error('‚ùå GET Error:', error.message);
                throw error;
            }
        }

        /**
         * ‡∏™‡πà‡∏á POST request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á API
         */
        async function apiPost(action, payload = {}) {
            try {
                const body = JSON.stringify({
                    action,
                    ...payload
                });
                
                console.log('üì§ POST:', action, payload);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body,
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('üì• Response:', data);
                
                return data;
            } catch (error) {
                console.error('‚ùå POST Error:', error.message);
                throw error;
            }
        }

        // ============ PRODUCT API ============

        /**
         * ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£
         */
        async function getProducts() {
            try {
                const products = await apiGet('getProducts');
                
                if (products.error) {
                    throw new Error(products.message || 'Unknown error');
                }
                
                return products;
            } catch (error) {
                console.error('Failed to get products:', error);
                return [];
            }
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π
         */
        function displayProducts(products) {
            const container = document.getElementById('product-list');
            
            if (!container) {
                console.error('Product container not found');
                return;
            }
            
            if (!products || products.length === 0) {
                container.innerHTML = `
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Error object ‡∏´‡∏£‡∏∑‡∏≠ Product array
            if (products[0] && products[0].error) {
                container.innerHTML = `
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="empty-state">
                                <p>‚ö†Ô∏è ${products[0].message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'}</p>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
            const html = products.map((product, index) => `
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="product-card ${!product.InStock ? 'out-of-stock' : ''}" 
                         onclick="addToCart(${index}, '${product.Menu}', ${product.Price})">
                        <div class="product-img-container">
                            <img src="${product.Image || 'https://via.placeholder.com/300'}" 
                                 class="product-img" 
                                 alt="${product.Menu}"
                                 onerror="this.src='https://via.placeholder.com/300'">
                            ${!product.InStock ? '<div class="out-of-stock-overlay"><span>‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å</span></div>' : ''}
                            <div class="stock-badge">${product.InStock ? '‡∏°‡∏µ' : '‡∏´‡∏°‡∏î'}</div>
                        </div>
                        <div class="product-info">
                            <h5 class="product-name">${product.Menu}</h5>
                            <p class="product-price">${parseFloat(product.Price).toLocaleString('th-TH')} ‡∏ø</p>
                            <small class="product-category">${product.Category || ''}</small>
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = `<div class="row g-3">${html}</div>`;
        }

        // ============ MEMBER API ============

        /**
         * ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
         */
        async function getMemberProfile(uid, name = '') {
            try {
                const profile = await apiGet('getMember', { uid, name });
                return profile;
            } catch (error) {
                console.error('Failed to get member profile:', error);
                return null;
            }
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
         */
        function displayMemberBadge(profile) {
            const badge = document.getElementById('profile-info');
            
            if (!badge || !profile) return;
            
            const html = `
                <div class="member-badge">
                    <img src="${profile.userImage || 'https://via.placeholder.com/45'}" 
                         class="user-avatar" alt="Profile">
                    <div class="user-info">
                        <div class="user-name">${profile.name || '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ'}</div>
                        <div class="user-points text-warning">
                            <span class="points-icon"><i class="fas fa-coins"></i></span>
                            <span>${profile.points || 0} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (${profile.rank || 'New'})</span>
                        </div>
                    </div>
                </div>
            `;
            
            badge.innerHTML = html;
            badge.classList.remove('d-none');
        }

        // ============ ORDER API ============

        /**
         * ‡∏™‡πà‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
         */
        async function submitOrder(orderData) {
            try {
                // Validate
                if (!orderData.name || !orderData.phone || !orderData.total) {
                    throw new Error('Missing required fields: name, phone, total');
                }
                
                // Convert image to base64 if exists
                let imageData = null;
                if (orderData.slipImage) {
                    imageData = await fileToBase64(orderData.slipImage);
                }
                
                const payload = {
                    ...orderData,
                    image: imageData
                };
                
                const response = await apiPost('submitOrder', payload);
                
                if (response.result !== 'Success') {
                    throw new Error(response.message || 'Order submission failed');
                }
                
                return response;
            } catch (error) {
                console.error('Failed to submit order:', error);
                throw error;
            }
        }

        /**
         * ‡∏î‡∏∂‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
         */
        async function getAdminOrders() {
            try {
                const orders = await apiGet('getAdminOrders');
                return orders;
            } catch (error) {
                console.error('Failed to get admin orders:', error);
                return [];
            }
        }

        /**
         * ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
         */
        async function updateOrderStatus(orderId, newStatus) {
            try {
                if (!orderId || !newStatus) {
                    throw new Error('Missing orderId or newStatus');
                }
                
                const response = await apiPost('updateStatus', {
                    orderId,
                    newStatus
                });
                
                if (response.result !== 'Success') {
                    throw new Error(response.message || 'Status update failed');
                }
                
                return response;
            } catch (error) {
                console.error('Failed to update order status:', error);
                throw error;
            }
        }

        // ============ OWNER API ============

        /**
         * ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
         */
        async function getOwnerStats() {
            try {
                const stats = await apiGet('getOwnerStats');
                return stats;
            } catch (error) {
                console.error('Failed to get owner stats:', error);
                return null;
            }
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
         */
        function displayStats(stats) {
            if (!stats) return;
            
            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó HTML elements
            const statToday = document.getElementById('stat-today');
            const statOrders = document.getElementById('stat-orders');
            const statRealized = document.getElementById('stat-realized');
            const statPending = document.getElementById('stat-pending');
            
            if (statToday) statToday.textContent = (stats.totalToday || 0).toLocaleString('th-TH');
            if (statOrders) statOrders.textContent = stats.ordersCount || 0;
            if (statRealized) statRealized.textContent = (stats.realized || 0).toLocaleString('th-TH');
            if (statPending) statPending.textContent = (stats.pending || 0).toLocaleString('th-TH');
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
         */
        async function displayAdminOrders() {
            try {
                const orders = await getAdminOrders();
                const table = document.getElementById('admin-orders-table');
                
                if (!table) return;
                
                if (!orders || orders.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted py-3">
                                ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const html = orders.map(order => `
                    <tr>
                        <td><strong>${order.orderId}</strong></td>
                        <td>${order.name}</td>
                        <td>${parseFloat(order.total).toLocaleString('th-TH')} ‡∏ø</td>
                        <td>
                            <span class="badge bg-info">${order.status}</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showOrderOptions('${order.orderId}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
                
                table.innerHTML = html;
            } catch (error) {
                console.error('Error displaying orders:', error);
            }
        }

        // ============ MAPS API ============

        /**
         * ‡∏î‡∏∂‡∏á Maps API Key
         */
        async function getMapsApiKey() {
            try {
                const response = await apiGet('getMapsKey');
                return response.key;
            } catch (error) {
                console.error('Failed to get Maps API key:', error);
                return null;
            }
        }

        // ============ HELPER FUNCTIONS ============

        /**
         * ‡πÅ‡∏õ‡∏•‡∏á File ‡πÄ‡∏õ‡πá‡∏ô Base64
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /**
         * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Staff
         */
        async function checkStaffAccess(uid) {
            try {
                const response = await apiGet('checkStaff', { uid });
                return response.isStaff || false;
            } catch (error) {
                console.error('Failed to check staff access:', error);
                return false;
            }
        }

        /**
         * Retry logic ‡∏ñ‡πâ‡∏≤ API ‡∏•‡πâ‡∏°
         */
        async function apiWithRetry(fn, maxRetries = 3) {
            let lastError;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    lastError = error;
                    console.warn(`Retry ${i + 1}/${maxRetries}:`, error.message);
                    
                    // ‡∏£‡∏≠ 1 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            throw lastError;
        }

        // ============ UI FUNCTIONS ============

        /**
         * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
         */
        function addToCart(index, name, price) {
            console.log(`Added to cart: ${name} - ${price} ‡∏ø`);
            Swal.fire({
                icon: 'success',
                title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß',
                text: `${name} x1`,
                timer: 1500,
                showConfirmButton: false
            });
        }

        /**
         * ‡πÄ‡∏õ‡∏¥‡∏î Cart Modal
         */
        function openCartModal() {
            Swal.fire({
                title: '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
                html: '<p>‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡πÄ‡∏£‡πá‡∏ß‡πÜ‡∏ô‡∏µ‡πâ</p>',
                icon: 'info'
            });
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô Staff Dashboard
         */
        function showStaffDashboard() {
            document.getElementById('staff-dashboard').style.display = 'block';
            refreshDashboard();
        }

        function hideStaffDashboard() {
            document.getElementById('staff-dashboard').style.display = 'none';
        }

        /**
         * ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä Dashboard
         */
        async function refreshDashboard() {
            try {
                const stats = await getOwnerStats();
                displayStats(stats);
                await displayAdminOrders();
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
            }
        }

        /**
         * ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
         */
        function filterProduct(category, event) {
            event.preventDefault();
            console.log('Filter by category:', category);
            // TODO: Implementation
        }

        /**
         * ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
         */
        function showOrderOptions(orderId) {
            Swal.fire({
                title: '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                input: 'select',
                inputOptions: {
                    '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£': '‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£',
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£',
                    '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á': '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á',
                    '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô': '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                    '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å': '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
                },
                inputPlaceholder: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞',
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: async (status) => {
                    if (!status) return;
                    try {
                        await updateOrderStatus(orderId, status);
                        await displayAdminOrders();
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    } catch (error) {
                        Swal.fire('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
                    }
                }
            });
        }

        // ============ INITIALIZATION ============

        /**
         * ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing Mini Shop...');
            
            try {
                // ‡∏î‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π
                const products = await apiWithRetry(() => getProducts());
                displayProducts(products);
                
                // ‡∏î‡∏∂‡∏á Maps API Key
                const mapsKey = await getMapsApiKey();
                if (mapsKey) {
                    console.log('‚úÖ Maps API Key loaded');
                }
                
                console.log('‚úÖ Mini Shop initialized successfully');
            } catch (error) {
                console.error('‚ùå Initialization error:', error);
                Swal.fire({
                    icon: 'error',
                    title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                    text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠',
                    allowOutsideClick: false
                });
            }
        });

        // ============ EXPORT FOR TESTING ============
        // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Console
        window.API = {
            getProducts,
            getMemberProfile,
            submitOrder,
            getAdminOrders,
            updateOrderStatus,
            getOwnerStats,
            getMapsApiKey,
            checkStaffAccess
        };
    </script>
</body>
</html>
